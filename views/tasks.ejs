<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tareas de la Lista - <%= list.nom %></title> <%-- El nombre de la lista en el tÃ­tulo --%>
    <link rel="stylesheet" href="/home.css" />
    <link rel="stylesheet" href="../public/styles.css" />  
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo-header">
          <img src="/logo_laDolca.png" alt="logo" />
          <h1>Gestor de Tareas</h1>
        </div>

        <button id="logout" class="btn">Tancar sessiÃ³</button>
      </nav>
    </header>
    <body>
      <div class="content">
        <div class="header-view">
          <h1>Tareas de la Lista: âœ¨ <%= list.nom %> âœ¨</h1> <%-- Muestra el nombre de la lista --%>
          <div class="header-buttons">
            <a href="/lists/<%= list.id_list %>" class="btn back-button">â¬…ï¸ Volver a la Lista</a> <%-- Vuelve al detalle de la lista --%>
            <a href="/lists/<%= list.id_list %>/tasks/new" class="btn edit-button">â• AÃ±adir Nueva Tarea</a> <%-- Enlace para aÃ±adir tarea a esta lista --%>
          </div>
        </div>
        <div class="grid">
          <% if (data && data.length > 0) { %>
            <% data.forEach(task => { %> <%-- Iterar sobre las tareas --%>
            <div class="card task-card"> <%-- Cambiado de product-card a task-card --%>
              <h3 class="task-name">ğŸ“ <%= task.titol %></h3> <%-- Cambiado de product-name a task-name --%>
              <p class="task-description"><%= task.descripcio.substring(0, 70) %><%= task.descripcio.length > 70 ? '...' : '' %></p> <%-- DescripciÃ³n corta --%>
              <p class="task-status-priority">Estado: <strong><%= task.estat %></strong> | Prioridad: <strong><%= task.prioritat %></strong></p>
              <div class="task-actions"> <%-- Cambiado de product-actions a task-actions --%>
                <a href="/tasks/<%=task.id_task %>" class="btn btn-primary"> <%-- Enlace al detalle de la tarea --%>
                  Ver Detalles
                </a>
                <button class="btn btn-danger btn-delete-task" data-id="<%=task.id_task %>" data-list-id="<%= list.id_list %>"> <%-- Cambiado el id del botÃ³n y data-id --%>
                  ğŸ—‘ï¸ Eliminar Tarea
                </button>
              </div>
            </div>
            <% }) %>
          <% } else { %>
            <p style="text-align: center; width: 100%; color: #6b4423; font-size: 18px; margin-top: 50px;">
              Esta lista no tiene tareas todavÃ­a. Â¡Es un buen momento para aÃ±adir una!
            </p>
          <% } %>
        </div>
      </div>
    </body>
  </body>

  <script>
    const logoutButton = document.getElementById("logout");
    const deleteTaskButtons = document.querySelectorAll(".btn-delete-task"); // Selector actualizado

    // Logout functionality
    logoutButton?.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        const response = await fetch("/api/auth/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });
        if (response.ok) {
          window.location.href = "/";
        } else {
          alert("Error al cerrar sesiÃ³n.");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Error de red al intentar cerrar sesiÃ³n.");
      }
    });

    // Delete Task functionality
    deleteTaskButtons.forEach(button => {
      button.addEventListener("click", async (e) => {
        e.preventDefault();
        
        const taskId = button.getAttribute("data-id");
        const listId = button.getAttribute("data-list-id"); // Para redirigir correctamente
        
        const confirmed = confirm("Â¿EstÃ¡s seguro de que quieres eliminar esta tarea? ğŸ—‘ï¸ğŸ˜¥");
        
        if (confirmed) {
          try {
            const response = await fetch(`/api/tasks/${taskId}`, { // Ruta de API para tareas
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              alert("Tarea eliminada correctamente.");
              window.location.href = `/lists/${listId}`; // Recargar la pÃ¡gina de la lista padre para mostrar la lista de tareas actualizada
            } else {
              const errorText = await response.text();
              console.error("Error al eliminar la tarea:", errorText);
              alert("Error al eliminar la tarea. Por favor, intÃ©ntalo de nuevo.");
            }
          } catch (error) {
            console.error("Error de red al eliminar la tarea:", error);
            alert("Error de red al eliminar la tarea. Por favor, intÃ©ntalo de nuevo.");
          }
        }
      });
    });
  </script>
</html>