<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login and registration</title>
    <link rel="stylesheet" type="text/css" href="/login.css" />
    <style>
      /* Estilo para ocultar elementos */
      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <% if (typeof username!='undefined' ) { %>
      <div class="form-container">
        <h2>Hola <%=username%>!</h2>
        <p>Estas en el panel de admin</p>
        <button id="close-session">Cerrar sesión</button>
        <a href="/lists">Seguir administrando</a>
      </div>
      <% } %> <% if (typeof username==='undefined' ) { %>
      <!-- Los botones de pestaña ahora son enlaces dentro de cada formulario -->
      <!-- y NO están en la sección .tab-buttons superior -->

      <div id="login-section" class="form-container">
        <form id="login-form">
          <h2>Login</h2>
          <label for="login-username">Username:</label>
          <input type="text" id="login-username" name="username" required />

          <label for="login-password">Password</label>
          <input type="password" id="login-password" name="password" required />

          <button type="submit">Login</button>
          <span>&nbsp;</span>
          <!-- Enlace para ir al registro, al final del formulario de login -->
          <p class="switch-form-text">
            ¿No tienes cuenta? <a href="#" id="go-to-register">Regístrate</a>
          </p>
        </form>
      </div>

      <div id="register-section" class="form-container hidden">
        <form id="register-form">
          <h2>Register</h2>
          <label for="register-username">Username:</label>
          <input type="text" id="register-username" name="username" required />

          <label for="register-password">Password</label>
          <input
            type="password"
            id="register-password"
            name="password"
            required
          />

          <label for="register-confirm-password">Password</label>
          <input
            type="password"
            id="register-confirm-password"
            name="confirm-password"
            required
          />

          <button type="submit">Register</button>
          <span>&nbsp;</span>
          <!-- Enlace para ir al login, al final del formulario de registro -->
          <p class="switch-form-text">
            ¿Ya tienes cuenta? <a href="#" id="go-to-login">Inicia sesión</a>
          </p>
        </form>
      </div>
      <% } %>
    </div>

    <script>
      const $ = (el) => document.querySelector(el);
      const loginForm = $("#login-form");
      const loginSpan = $("#login-form span");

      const registerForm = $("#register-form");
      const registerSpan = $("#register-form span");

      const logoutButton = $("#close-session");

      // Elementos para el control de visibilidad
      const loginSection = $("#login-section");
      const registerSection = $("#register-section");

      // NUEVOS IDs para los enlaces de alternancia
      const goToRegisterLink = $("#go-to-register");
      const goToLoginLink = $("#go-to-login");

      // Funciones para alternar vistas (simplificadas sin manejar clases 'active' en botones superiores)
      const showLogin = () => {
        loginSection.classList.remove("hidden");
        registerSection.classList.add("hidden");
        if (loginSpan) loginSpan.innerText = "\u00A0";
        if (registerSpan) registerSpan.innerText = "\u00A0";
        if (registerForm) registerForm.reset();
      };

      const showRegister = () => {
        registerSection.classList.remove("hidden");
        loginSection.classList.add("hidden");
        if (loginSpan) loginSpan.innerText = "\u00A0";
        if (registerSpan) registerSpan.innerText = "\u00A0";
        if (loginForm) loginForm.reset();
      };

      // Event listeners para los enlaces de alternancia
      goToRegisterLink?.addEventListener("click", (e) => {
        e.preventDefault(); // Evita que la página salte al #
        showRegister();
      });

      goToLoginLink?.addEventListener("click", (e) => {
        e.preventDefault(); // Evita que la página salte al #
        showLogin();
      });

      // --- Tu JavaScript existente para login/registro/logout (sin cambios aquí) ---
      loginForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        const username = $("#login-username").value;
        const password = $("#login-password").value;

        fetch("/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username, password }),
        }).then((res) => {
          if (res.ok) {
            loginSpan.innerText = "Session iniciada ..Entrando..";
            loginSpan.style.color = "green";
            setTimeout(() => {
              window.location.href = "/lists";
            }, 2000);
          } else {
            loginSpan.innerText = "Error al iniciar session";
            loginSpan.style.color = "red";
          }
        });
      });

      registerForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = $("#register-username").value;
        const password = $("#register-password").value;
        const confirmPassword = $("#register-confirm-password").value;

        if (password.length < 6) {
          registerSpan.innerText = "La contraseña debe tener mínimo 6 caracteres";
          registerSpan.style.color = "red";
          return;
        }

        if (password != confirmPassword) {
          registerSpan.innerText = "Las contraseñas no coinciden";
          registerSpan.style.color = "red";
          return;
        }

        try {
          const res = await fetch("/api/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });
          if (res.ok) {
            registerSpan.innerText = "Usuario registrado. ..Entrando..";
            registerSpan.style.color = "green";
            setTimeout(() => {
              window.location.href = "/home";
            }, 2000);
          } else {
            const errorText = await res.text();
            registerSpan.innerText = errorText || "Error al registrar usuario";
            registerSpan.style.color = "red";
          }
        } catch (err) {
          registerSpan.innerText = "Error de conexión con el servidor";
          registerSpan.style.color = "red";
        }
      });

      logoutButton?.addEventListener("click", (e) => {
        e.preventDefault();
        fetch("/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        }).then((res) => {
          console.log(res);
          window.location.href = "/";
        });
      });
    </script>
  </body>
</html>
